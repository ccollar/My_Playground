name: Validate Issue Fields

on:
  issues:
    types: [opened]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Get Issue Data
        uses: actions/github-script@v6
        id: issue_data
        with:
          script: |
            const issue = context.payload.issue;
            let body = issue.body.replace(/\r\n/g, '\n');
            const userNameRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;

            core.info(`Raw Issue Body: ${body}`); // Debug: Print the issue body

            const userNameSectionStart = body.indexOf('### User Name');
            if (userNameSectionStart !== -1) {
              const userNameStart = body.indexOf('\n', userNameSectionStart) + 1;
              const userNameEnd = body.indexOf('\n', userNameStart);
              if (userNameStart !== -1 && userNameEnd !== -1){
                const userName = body.substring(userNameStart, userNameEnd).trim();

                core.info(`Extracted User Name: ${userName}`); // Debug: Print the extracted username

                if (!userNameRegex.test(userName)) {
                  return { valid: false, userName: userName };
                } else {
                  return { valid: true };
                }
              } else {
                return {valid: false, userName: "Could not parse username"}
              }
            } else {
              return { valid: false, userName: "User Name field not found" };
            }
